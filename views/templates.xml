<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="dtn_product_variants_stock_check" inherit_id="website_sale.product" name="DTN Stock Check Script">
        <xpath expr="//div[@id='product_details']" position="before">
            <input type="hidden" id="dtn_stock_data" t-att-value="dtn_stock_map_json"/>
            
            <style>
                /* Основной контейнер отсутствующего варианта */
                .dtn-out-of-stock {
                    opacity: 0.6 !important; /* Делаем элемент бледным */
                }
                
                /* Стили конкретно для текста внутри лейбла */
                .dtn-out-of-stock label, 
                .dtn-out-of-stock .form-check-label, 
                .dtn-out-of-stock span.attribute_name {
                    text-decoration: line-through !important; /* Перечеркивание */
                    text-decoration-color: #dc3545 !important; /* Цвет линии (красноватый для наглядности) или #999 для серого */
                    text-decoration-thickness: 2px !important; /* Толщина линии */
                    color: #adb5bd !important; /* Цвет самого текста (серый) */
                    cursor: pointer !important; /* Курсор руки */
                }
                
                /* Убираем перечеркивание с самой радио-кнопки/чекбокса, если оно туда попало */
                .dtn-out-of-stock input {
                    text-decoration: none !important;
                    cursor: pointer !important;
                }

                /* Специфично для выпадающих списков (Select) */
                option.dtn-out-of-stock {
                    color: #adb5bd;
                    font-style: italic;
                    /* text-decoration в select/option работает не во всех браузерах, но цвет сработает точно */
                }
            </style>
        </xpath>

        <xpath expr="//div[@id='product_details']" position="inside">
            <script type="text/javascript">
//<![CDATA[
document.addEventListener('DOMContentLoaded', function () {
    const stockDataInput = document.getElementById('dtn_stock_data');
    if (!stockDataInput) return;

    let stockMap = {};
    try {
        stockMap = JSON.parse(stockDataInput.value);
    } catch (e) {
        console.error('DTN Error parsing stock JSON:', e);
        return;
    }

    const productContainer = document.getElementById('product_details');
    let isInitialLoad = true;

    function applyStockStyles() {
        // 1. SELECT (випадаючі списки)
        const options = productContainer.querySelectorAll('select.js_variant_change option');
        options.forEach(opt => {
            const valId = parseInt(opt.value);
            if (valId && !stockMap[valId]) {
                if (!opt.text.includes('(Немає)')) {
                    opt.text = opt.text + ' (Немає)';
                }
                opt.classList.add('dtn-out-of-stock');
                opt.disabled = false;
                opt.removeAttribute('disabled');
            }
        });

        // 2. RADIO / COLORS / PILLS (кнопки)
        const inputs = productContainer.querySelectorAll('input.js_variant_change, input[name^="attribute_"]');
        inputs.forEach(input => {
            const valId = parseInt(input.value) || parseInt(input.getAttribute('data-value_id'));
            
            if (valId) {
                // Шукаємо найближчий контейнер для стилізації
                // В Odoo 18 це часто label або div.form-check
                const parentElement = input.closest('.list-inline-item') || input.closest('.form-check') || input.closest('label');
                
                // Скидання стандартного блокування Odoo
                input.disabled = false;
                input.classList.remove('disabled');
                if (parentElement) parentElement.classList.remove('disabled');

                if (!stockMap[valId]) {
                    if (parentElement) {
                        parentElement.classList.add('dtn-out-of-stock');
                        parentElement.title = "Немає в наявності, але можна вибрати для передзамовлення";
                    }
                } else {
                    if (parentElement) {
                        parentElement.classList.remove('dtn-out-of-stock');
                    }
                }
            }
        });
    }

    function checkAndSwitchIfEmpty() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('product_id')) return; 

        const checkedInput = productContainer.querySelector('input.js_variant_change:checked, input[name^="attribute_"]:checked');
        if (checkedInput) {
             const valId = parseInt(checkedInput.value) || parseInt(checkedInput.getAttribute('data-value_id'));
             if (valId && !stockMap[valId]) {
                 const allInputs = productContainer.querySelectorAll('input.js_variant_change, input[name^="attribute_"]');
                 for (let input of allInputs) {
                     const nextId = parseInt(input.value) || parseInt(input.getAttribute('data-value_id'));
                     if (nextId && stockMap[nextId]) {
                         input.click();
                         break;
                     }
                 }
             }
        }
    }

    applyStockStyles();
    
    if (isInitialLoad) {
        setTimeout(checkAndSwitchIfEmpty, 200); 
        isInitialLoad = false;
    }

    const observer = new MutationObserver((mutations) => {
        let shouldUpdate = false;
        mutations.forEach(mutation => {
            if (mutation.type === 'childList' && mutation.target.id !== 'product_details') {
                shouldUpdate = true;
            }
        });
        if (shouldUpdate) {
           applyStockStyles();
        }
    });

    if (productContainer) {
        observer.observe(productContainer, {
            childList: true,
            subtree: true
        });
    }
});
//]]>
            </script>
        </xpath>
    </template>
</odoo>